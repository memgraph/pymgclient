name: CI

on: [push]

jobs:
  build_and_test_ubuntu:
    strategy:
     matrix:
        platform: [ubuntu-18.04]
    runs-on: ${{ matrix.platform }}
    steps:
    - name: Install system dependencies (Ubuntu 18.04)
      if: matrix.platform == 'ubuntu-18.04'
      run: |
        sudo apt install -y libpython3.7 python3-pip python3-setuptools
        sudo pip3 install networkx pytest pyopenssl sphinx
        mkdir ~/memgraph
        curl -L https://memgraph.com/download/memgraph/v1.2.0/ubuntu-18.04/memgraph_1.2.0-community-1_amd64.deb > ~/memgraph/memgraph_1.2.0-community-1_amd64.deb
        sudo ln -s /dev/null /etc/systemd/system/memgraph.service # Prevents Memgraph from starting.
        sudo dpkg -i ~/memgraph/memgraph_1.2.0-community-1_amd64.deb

    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Install, test and build docs
      run: |
        sudo python3 setup.py install
        MEMGRAPH_PORT=10000 python3 -m pytest
        cd docs
        make html

  build_windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include: [
          { msystem: MINGW64, msystem_arch: x86_64, mgversion: "1.4.0", python_arch: "win64", python_version: "3.8", python_abi_version: "cp36"}
        ]
    steps:
      - name: Set-up repository
        uses: actions/checkout@v2
      - name: Setup python
        uses: actions/setup-python@v2.2.2
        with:
          python-version: ${{ matrix.python_version }}
          architecture: ${{ matrix.python_arch }}
      - uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msystem }}
          update: true
          install: git mingw-w64-${{ matrix.msystem_arch }}-toolchain mingw-w64-${{ matrix.msystem_arch }}-cmake mingw-w64-${{ matrix.msystem_arch }}-openssl
      - name: Add mingw64 to PATH
        run: echo "C:\\msys64\\mingw64\\bin" >> $GITHUB_PATH
      - name: Build pymgclient
        run: python setup.py bdist_wheel --py-limited-api=${{ matrix.python_abi_version }}
